<% current_user_invited = Invitation.find(current_user.invitation_id) %>
<% if !current_user_invited.blank? && !current_user_invited.sender.blank? && !current_user_invited.sender.email == 'admin@vmwdemo.com' %>
	<br/>
	<h3>Account Details</h3>
	<div>
		Your account was created by <strong><%= current_user_invited.sender.display_name %></strong> and their email is <strong><%= mail_to current_user_invited.sender.email %></strong>
	</div>
<% end %>

<% if policy(current_user).invites? %>
	<br/>
	<h3>Organizations and Users</h3>

	<%
		invitations = Invitation.order(:recipient_company).each
		invitation = invitations.next rescue nil
		previous_recipient_company = invitation ? invitation.recipient_company : nil

		while invitation
	%>
		<div class="dashboard-table">
			<table>
				<tbody>
					<tr>
						<td class="logo"><i class="icon-users"></i></td>
						<td class="orgname"><%= previous_recipient_company %></td>
						<td class="usercount">x Active Users</td>
						<td class="op"><span>Opportunities</span>$xx,xxx</td>
					</tr>
				</tbody>
			</table>
			<table>
				<thead>
					<tr>
						<th></th>
						<th>Name</th>
						<th>E-Mail</th>
						<th>Last Login</th>
						<th>Days Left</th>
						<th>Admin</th>
					</tr>
				</thead>
				<tbody>
					<% begin %>
						<tr data-id="<%= invitation.id.to_s %>" data-recipient_firstname="<%= invitation.recipient_firstname %>" data-recipient_lastname="<%= invitation.recipient_lastname %>" data-expires_at="<%= invitation.expires_at.to_s(:iso8601) %>">
							<td class="avatar"><img src="assets/default_avatar.png"/></td>
							<td class="name"><%= invitation.recipient_firstname %> <%= invitation.recipient_lastname %></td>
							<td><%= invitation.recipient_email %></td>
							<td>3 days ago</td>

							<% extension = Extension.where(recipient: invitation.id).last %>
							<% if extension.nil? %>
								<td>
									<%= (invitation.expires_at).to_date.to_formatted_s(:long) %>
									<a class="extend-account-link-ro" href="#" data-toggle="modal" data-target="#extend-account-modal" class="extend-user invite-user-link popoverExtendAccount" rel="popover" data-trigger="hover" data-placement="bottom"><span> (Extend)</span></a>
								</td>
							<% else %>
								<td>
									<span class="popoverExpiresAt" rel="popover" data-trigger="hover" data-placement="bottom" data-content="Reason: <%= extension.reason %>">
										<%= (invitation.expires_at).to_date.to_formatted_s(:long) %> (Extended)
									</span>
								</td>
							<% end %>

							<td class="admin"></td>
						</tr>
					<%
							invitation = invitations.next rescue nil
						end while invitation && previous_recipient_company == invitation.recipient_company

						previous_recipient_company = invitation ? invitation.recipient_company : nil
					%>
				</tbody>
			</table>
		</div>
	<% end %>

	<br/><br/><br/>

	<% invites_remaining = current_user.total_invitations - current_user.invitations_used %>
	<% if invites_remaining > 0 || current_user.role == 'admin' %>
		<a href="#" data-toggle="modal" data-target="#form-validation-modal" class="new-user btn btn-success pull-left invite-user-link popoverInviteUserLink" rel="popover" data-trigger="hover" data-placement="bottom">Invite user</a>
	<% else %>
		<button type="button" class="btn btn-success" data-dismiss="modal" disabled="true">Invite user</button>
	<% end %>

	<!-- Extend account Modal -->
	<div class="modal fade" id="extend-account-modal" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="extend-account-form" method="post" action="/extend_invitation" role="form">
					<input type="hidden" value="<%= form_authenticity_token() %>" name="authenticity_token"/>
					<input type="hidden" name="invitationId" id="invitationId"/>
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Extend Account</h4>
					</div>
					<div class="modal-body">
						This action will extend the user's account by a month. This will be a one-time extension and the users account will be deleted from the system once the expiration date has been reached. <br/><br/>
						<div class="form-group">
							<label>User:</label>
							<input type="text" name="user" id="invitationUser" class="form-control" readonly="true" />
						</div>
						<div class="form-group">
							<label>Reason:</label>
							<input type="text" name="reason" class="form-control" placeholder="Please enter reason for extension" />
						</div>
						<div class="form-group">
							<label>New Expiration Date:</label>
							<input type="text" name="expiresAt" id="expiresAtRo" class="form-control" readonly="true"/>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-success">Submit request</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Form with Validation Modal -->
	<div class="modal fade" id="form-validation-modal" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="new-invitation-form" method="post" action="/invitations" role="form">
					<input type="hidden" value="<%= form_authenticity_token() %>" name="authenticity_token"/>

					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Invite User</h4>
					</div>

					<div class="modal-body">
						<div class="form-group">
							<label>First name:</label>
							<input type="text" name="invitation[recipient_firstname]" class="form-control" />
						</div>
						<div class="form-group">
							<label>Last name:</label>
							<input type="text" name="invitation[recipient_lastname]" class="form-control" />
						</div>
						<div class="form-group">
							<label>Email:</label>
							<input type="email" name="invitation[recipient_email]" class="form-control" />
						</div>
						<div class="form-group">
							<label>Username:</label>
							<input type="text" name="invitation[recipient_username]" placeholder="(optional)" class="form-control" />
						</div>
						<div class="form-group">
							<label>Company:</label>
							<input type="text" name="invitation[recipient_company]" class="form-control" />
						</div>
						<div class="form-group">
							<label>Job Title:</label>
							<input type="text" name="invitation[recipient_title]" class="form-control" />
						</div>
						<div class="form-group">
							<label>Potential number of users:</label>
							<input type="text" name="invitation[potential_seats]" class="form-control popoverPotentialSeatsModal" />
						</div>
						<div class="form-group">
							<label>Region:</label>
							<select class="form-control required" name="invitation[region]">
								<option value="">Select Region</option><option value="AMER">AMER</option>
								<option value="EMEA">EMEA</option>
								<option value="APAC">APAC</option>
							</select>
						</div>
						<div class="form-group">
							<label>AirWatch Trial:</label>
							<select class="form-control required" name="invitation[airwatch_trial]">
								<option value="">AirWatch Trial</option>
								<option value="true">Yes</option>
								<option value="false">No</option>
							</select>
						</div>
						<div class="info">
							A 30-day account will be setup for the user. After the 30-day trial ends, the user's <strong>account will automatically be deleted from the system.</strong>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-success" id="send-invite" >Send Invite</button>
					</div>
				</form>
			</div>
		</div>
	</div>
<% end %>
